name: Codex AutoFix (fix CI failures once)

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

concurrency:
  group: codex-autofix
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  autofix:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Find PRs associated with failing commit
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const sha = context.payload.workflow_run.head_sha;
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha,
            });
            if (!prs.data.length) {
              core.setOutput('pr_number', '');
              return;
            }
            // pick first PR
            core.setOutput('pr_number', String(prs.data[0].number));

      - name: Stop if no PR found
        if: ${{ steps.pr.outputs.pr_number == '' }}
        run: echo "No PR associated with failing CI. Exiting."

      - name: Guard: only run for codex-managed PRs and only once
        if: ${{ steps.pr.outputs.pr_number != '' }}
        id: guard
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const prNumber = Number('${{ steps.pr.outputs.pr_number }}');
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const labels = (pr.labels || []).map(l => l.name);
            const isCodex = labels.includes('codex-pr-open');
            const alreadyTried = labels.includes('autofix-1');

            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('is_codex', String(isCodex));
            core.setOutput('already_tried', String(alreadyTried));

      - name: Stop if not codex-managed or already tried
        if: ${{ steps.guard.outputs.is_codex != 'true' || steps.guard.outputs.already_tried == 'true' }}
        run: |
          echo "Skip: is_codex=${{ steps.guard.outputs.is_codex }} already_tried=${{ steps.guard.outputs.already_tried }}"

      - name: Checkout PR head
        if: ${{ steps.guard.outputs.is_codex == 'true' && steps.guard.outputs.already_tried != 'true' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.guard.outputs.head_ref }}

      - uses: pnpm/action-setup@v4
        if: ${{ steps.guard.outputs.is_codex == 'true' && steps.guard.outputs.already_tried != 'true' }}
        with:
          version: 9

      - uses: actions/setup-node@v4
        if: ${{ steps.guard.outputs.is_codex == 'true' && steps.guard.outputs.already_tried != 'true' }}
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm i --frozen-lockfile
        if: ${{ steps.guard.outputs.is_codex == 'true' && steps.guard.outputs.already_tried != 'true' }}

      - name: Prepare Codex prompt
        if: ${{ steps.guard.outputs.is_codex == 'true' && steps.guard.outputs.already_tried != 'true' }}
        run: |
          mkdir -p .codex
          cat > .codex/prompt.txt << 'EOF'
          Fix the CI failures on this branch.
          Requirements:
          - Follow AGENTS.md.
          - Make minimal changes.
          - Run: pnpm lint, pnpm typecheck, pnpm test and make them pass.
          - Do NOT touch secrets or add risky dependencies.
          EOF

      - name: Run Codex (attempt fix)
        if: ${{ steps.guard.outputs.is_codex == 'true' && steps.guard.outputs.already_tried != 'true' }}
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: .codex/prompt.txt
          sandbox: workspace-write

      - name: Re-run DoD commands
        if: ${{ steps.guard.outputs.is_codex == 'true' && steps.guard.outputs.already_tried != 'true' }}
        id: recheck
        run: |
          set -e
          pnpm lint
          pnpm typecheck
          pnpm test

      - name: Commit & push fix (if changes)
        if: ${{ steps.guard.outputs.is_codex == 'true' && steps.guard.outputs.already_tried != 'true' }}
        run: |
          git config user.name "codex-bot"
          git config user.email "codex-bot@users.noreply.github.com"
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes produced."
          else
            git add -A
            git commit -m "codex: autofix CI"
            git push
          fi

      - name: Label attempt + comment
        if: ${{ steps.guard.outputs.is_codex == 'true' && steps.guard.outputs.already_tried != 'true' }}
        uses: actions/github-script@v7
        env:
          CODEX_FINAL_MESSAGE: ${{ steps.run_codex.outputs.final-message }}
        with:
          github-token: ${{ github.token }}
          script: |
            const prNumber = Number('${{ steps.pr.outputs.pr_number }}');
            // mark attempt
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['autofix-1'],
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                'AutoFix attempt completed (1/1).',
                '',
                'Codex notes:',
                '----',
                (process.env.CODEX_FINAL_MESSAGE || '').trim(),
                '----',
              ].join('\n'),
            });

      - name: If still failing later, mark blocked (manual triage)
        if: ${{ steps.guard.outputs.is_codex == 'true' && steps.guard.outputs.already_tried != 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            // We cannot reliably know future CI result here (it will rerun on push).
            // If the next CI still fails, a human should triage.
            // Optional: add codex-blocked label here if you want to stop immediately.
            return;
